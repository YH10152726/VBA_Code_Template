Sub TS自動計算_追加情報付き()

    Dim wsInput As Worksheet, wsExtra As Worksheet, wsOutput As Worksheet
    Dim lastRow As Long, i As Long
    Dim 品名 As String, 備考 As String
    Dim 数量 As Double
    Dim TS合計 As Double
    Dim 鏡面補正 As Double: 鏡面補正 = 1
    
    ' シートの設定
    Set wsInput = Worksheets("品目票")
    Set wsExtra = Worksheets("追加情報")
    On Error Resume Next
    Set wsOutput = Worksheets("TS出力")
    If wsOutput Is Nothing Then
        Set wsOutput = Worksheets.Add
        wsOutput.Name = "TS出力"
    Else
        wsOutput.Cells.ClearContents
    End If
    On Error GoTo 0
    
    ' ヘッダー出力（品目票からの自動算出部分）
    wsOutput.Range("A1:E1").Value = Array("品名", "数量", "カテゴリ", "TS時間（h）", "備考")
    
    lastRow = wsInput.Cells(wsInput.Rows.Count, "B").End(xlUp).Row
    TS合計 = 0
    Dim outRow As Long: outRow = 2
    Dim TS As Double, カテゴリ As String
    
    ' 品目票シートから各行ごとにTSを算出（キーワードで分類）
    For i = 2 To lastRow
        ' 品名は余計な空白を除去＆大文字に変換して判定
        品名 = UCase(Trim(wsInput.Cells(i, 2).Value))
        数量 = wsInput.Cells(i, 3).Value
        備考 = wsInput.Cells(i, 4).Value
        
        TS = 0
        カテゴリ = ""
        
        If InStr(品名, "E-PIN") > 0 Then
            TS = 数量 * 0.2
            カテゴリ = "エジェクタピン"
        ElseIf InStr(品名, "スライド") > 0 Then
            TS = 数量 * 3
            カテゴリ = "スライド"
        ElseIf InStr(品名, "センターピン") > 0 Then
            TS = 数量 * 0.5
            カテゴリ = "センターピン"
        ElseIf InStr(品名, "リターンピン") > 0 Then
            TS = 数量 * 1
            カテゴリ = "リターンピン"
        ElseIf InStr(品名, "食い切り") > 0 Or InStr(品名, "くいきり") > 0 Then
            TS = 数量 * 2
            カテゴリ = "食い切り"
        ElseIf InStr(品名, "ガイドピン") > 0 Then
            TS = 数量 * 0.5
            カテゴリ = "ガイドピン"
        ElseIf InStr(品名, "ガイドブッシュ") > 0 Then
            TS = 数量 * 0.5
            カテゴリ = "ガイドブッシュ"
        ElseIf InStr(品名, "スプリング") > 0 Or InStr(品名, "MSWT") > 0 Then
            TS = 数量 * 0.3
            カテゴリ = "スプリング"
        End If
        
        ' 鏡面補正：備考に「鏡面」が含まれていれば1.3倍に設定
        If 鏡面補正 = 1 And InStr(備考, "鏡面") > 0 Then
            鏡面補正 = 1.3
        End If
        
        ' TSが算出できた行のみ出力
        If TS > 0 Then
            wsOutput.Cells(outRow, 1).Value = 品名
            wsOutput.Cells(outRow, 2).Value = 数量
            wsOutput.Cells(outRow, 3).Value = カテゴリ
            wsOutput.Cells(outRow, 4).Value = TS
            wsOutput.Cells(outRow, 5).Value = 備考
            outRow = outRow + 1
            TS合計 = TS合計 + TS
        End If
    Next i
    
    ' ここまでで品目票から算出したTS合計が得られる
    ' 次に、追加情報シートから補正パラメータを読み込みます。
    
    Dim moldWidth As Double, moldHeight As Double, contactSurface As Double, complexityFactor As Double
    moldWidth = wsExtra.Range("B2").Value      ' 金型横幅（mm）※例：650
    moldHeight = wsExtra.Range("B3").Value       ' 金型縦幅（mm）※例：650
    contactSurface = wsExtra.Range("C2").Value     ' 単品擦り合わせの接触面数 ※例：8
    complexityFactor = wsExtra.Range("D2").Value   ' 部品複雑度補正係数 ※例：1.0～1.5
    
    ' 金型サイズ補正：標準サイズは650×650(mm)とする
    Dim standardArea As Double, sizeCorrection As Double
    standardArea = 650 * 650
    sizeCorrection = (moldWidth * moldHeight) / standardArea
    If sizeCorrection < 1 Then sizeCorrection = 1 ' 最低補正は1
    
    ' 接触面追加時間：仮に1面あたり0.3hとする
    Dim contactTimePerSurface As Double: contactTimePerSurface = 0.3
    
    ' 最終TS計算：品目票からのTSに、接触面追加時間を加えた上で、複雑度と金型サイズ補正、鏡面補正を掛ける
    Dim finalTS As Double
    finalTS = (TS合計 + (contactSurface * contactTimePerSurface)) * complexityFactor * sizeCorrection * 鏡面補正
    
    ' 追加結果の出力（品目票の下、または別領域）
    Dim resultRow As Long: resultRow = outRow + 2
    wsOutput.Cells(resultRow, 3).Value = "合計TS（補正前）"
    wsOutput.Cells(resultRow, 4).Value = TS合計
    wsOutput.Cells(resultRow + 1, 3).Value = "接触面追加時間"
    wsOutput.Cells(resultRow + 1, 4).Value = contactSurface * contactTimePerSurface
    wsOutput.Cells(resultRow + 2, 3).Value = "金型サイズ補正係数"
    wsOutput.Cells(resultRow + 2, 4).Value = sizeCorrection
    wsOutput.Cells(resultRow + 3, 3).Value = "部品複雑度補正係数"
    wsOutput.Cells(resultRow + 3, 4).Value = complexityFactor
    wsOutput.Cells(resultRow + 4, 3).Value = "鏡面補正係数"
    wsOutput.Cells(resultRow + 4, 4).Value = 鏡面補正
    wsOutput.Cells(resultRow + 5, 3).Value = "最終TS時間"
    wsOutput.Cells(resultRow + 5, 4).Value = finalTS
    
    MsgBox "追加情報を含むTS計算が完了しました！", vbInformation

End Sub
